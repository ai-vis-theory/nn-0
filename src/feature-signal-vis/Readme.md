# Feature Signal Visualization and Analysis

This project aims to understand the internal workings of a neural network by visualizing and analyzing the "signals" or feature activations as they propagate through the layers. The primary focus is on understanding how feature representations are correlated within and between layers and how these correlations evolve during the training process.

## Core Concepts

The main idea is to treat the activations of each layer as a feature representation of the input data. By analyzing these representations, we can gain insights into what the model is learning.

This project explores two main types of analysis:

1.  **Layer-wise Cross-Correlation**: We compute the cross-correlation between the flattened outputs of every pair of layers in the network. This results in a matrix of correlation matrices, which helps us understand:
    *   How similar the representations are between different layers.
    *   How information is transformed from one layer to the next.
    *   Whether certain layers are redundant or serve distinct purposes.

2.  **Evolution of Correlations over Training**: The layer-wise correlations are computed at different points during training (e.g., at the beginning of each epoch). This allows us to see how the network's internal representations change as it learns.

3.  **Augmentation-driven Feature Variance**: We analyze how different data augmentations applied to the same input image affect the feature representations within the network. This helps to understand the stability and invariance of the learned features.

## Implementation Details

The analysis is performed using a simple Multi-Layer Perceptron (MLP) trained on the MNIST dataset.

### Key Components

*   **Dataset**: MNIST, loaded using `torchvision`.
*   **Model**: A 4-layer MLP with `BatchNorm`.
*   **Trainer**: A custom `Trainer` class that handles the training and validation loops.
*   **Callbacks**:
    *   `ModelSaveCallback`: Saves the model at regular intervals.
    *   `MetricsCallback`: Logs metrics (loss, accuracy, F1-score, etc.) to the console and TensorBoard.
*   **Analysis Functions**:
    *   `get_intermediate_outputs`: Extracts the activation outputs from each layer of the model.
    *   `compute_layerwise_cross_correlation`: Computes the correlation between layer activations.
    *   `plot_layerwise_correlations`: Visualizes the correlation matrices.
    *   `store_corr_means`: Persistently stores the mean of correlation matrices in a JSON file to track their evolution.

### Workflow

1.  **Data Loading**: The MNIST dataset is loaded and transformed.
2.  **Model Training**: The MLP model is trained on the dataset. The `Trainer` class orchestrates this process.
3.  **Correlation Analysis during Training**: At the beginning of each epoch, a batch of data is used to perform the layer-wise correlation analysis.
4.  **Visualization and Logging**:
    *   The correlation matrices are plotted and saved as images.
    *   The mean of these correlation matrices is logged to a JSON file to track changes over epochs.
    *   Training metrics are logged to TensorBoard.
5.  **Augmentation Analysis**: After training, the script performs an analysis on how data augmentations affect the feature representations for a single sample.

## How to Run

The code is structured as a script (originally from a Jupyter Notebook). To run it, you would typically execute the cells in order. The main training process is initiated by calling the `fit` method of the `Trainer` object.

## Outputs

The script generates several outputs:

*   **Saved Models**: The trained model weights are saved periodically (`.pth` files).
*   **TensorBoard Logs**: Training and validation metrics are saved in a logs directory for visualization with TensorBoard.
*   **Correlation Plots**: Images of the layer-wise correlation matrices are saved for each analysis step.
*   **Correlation Data**: A JSON file (`corr_means.json`) is created to store the history of mean correlation values between layers across epochs.

## Visualizations

Here are some of the visualizations generated by the project:

*   **Layer Feature Correlation (`assets/feature-signal-vis/layer_feature_correlation.png`)**: This image displays a correlation map between features of different layers (from layer `i` to layer `j`, where `i <= j`). It helps visualize how feature representations are related across the network's depth.

    ![Layer Feature Correlation](../../assets/feature-signal-vis/layer_feature_correlation.png)

*   **Augmented MNIST Samples (`assets/feature-signal-vis/augs/*.png`)**: These are sample images of an MNIST digit after applying a series of 300 different augmentations. This dataset is used to analyze feature stability.

    ![Augmented Sample 1](../../assets/feature-signal-vis/augs/1.png)
    ![Augmented Sample 2](../../assets/feature-signal-vis/augs/2.png)

*   **Intra-Layer Feature-Feature Correlation (`assets/feature-signal-vis/intra/l1_ff.png`, `assets/feature-signal-vis/intra/l4_ff.png`)**: These heatmaps show the neuron-to-neuron correlation within a single layer (e.g., the first and last layers). The dimensions are `feature x feature`, revealing internal feature dependencies.

    *   **First Layer (l1_ff.png)**: 
        ![First Layer Feature-Feature Correlation](../../assets/feature-signal-vis/intra/l1_ff.png)
    *   **Last Layer (l4_ff.png)**: 
        ![Last Layer Feature-Feature Correlation](../../assets/feature-signal-vis/intra/l4_ff.png)

*   **Intra-Layer Sample-Sample Correlation (`assets/feature-signal-vis/intra/l1_bb.png`, `assets/feature-signal-vis/intra/l4_bb.png`)**: These heatmaps show how features from different augmented versions of the same image correlate with each other. The dimensions are `#samples x #samples`, measured with respect to a specific layer's features. This illustrates feature robustness to augmentations.

    *   **First Layer (l1_bb.png)**:
        ![First Layer Sample-Sample Correlation](../../assets/feature-signal-vis/intra/l1_bb.png)
    *   **Last Layer (l4_bb.png)**:
        ![Last Layer Sample-Sample Correlation](../../assets/feature-signal-vis/intra/l4_bb.png)